{% extends 'base.html' %}
{% block content %}

<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-6">Catalog Sepatu Sneakers</h1>

    <!-- Filter Section -->
    <div class="flex space-x-4 mb-6">
        <!-- Price Filter Dropdown -->
        <div class="relative z-50"> <!-- Menambahkan z-50 untuk memastikan dropdown berada di atas produk -->
            <button id="price-dropdown-btn" class="px-4 py-2 bg-gray-200 rounded-full">
                Price
            </button>
            <div id="price-dropdown" class="absolute mt-2 w-80 bg-white border border-gray-200 rounded-lg shadow-lg p-4 hidden">
                <div class="flex justify-between items-center mb-4">
                    <span id="min-price-value" class="text-sm text-gray-600">$50</span>
                    <span id="max-price-value" class="text-sm text-gray-600">$500</span>
                </div>

                <div class="relative pt-1 mb-4">
                    <!-- Range Slider for Minimum Price -->
                    <div class="slider-container relative w-full">
                        <input type="range" min="50" max="500" value="50" id="min-price" class="w-full h-2 bg-gray-200 rounded-lg appearance-none">
                    </div>
                    <!-- Range Slider for Maximum Price -->
                    <div class="slider-container relative w-full mt-2">
                        <input type="range" min="50" max="500" value="500" id="max-price" class="w-full h-2 bg-gray-200 rounded-lg appearance-none">
                    </div>
                </div>

                <button id="apply-price-filter" class="mt-2 w-full bg-blue-500 text-white py-2 rounded-md shadow-md font-semibold transition duration-200 hover:bg-blue-600">
                    Apply
                </button>
            </div>
        </div>

        <!-- Placeholder for Active Filters -->
        <div id="active-filters" class="flex space-x-4"></div>
    </div>

    <!-- Product Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="product_table">
        <!-- Produk akan di-load di sini -->
    </div>
</div>

<script>
// Get slider elements
const minPriceSlider = document.getElementById('min-price');
const maxPriceSlider = document.getElementById('max-price');
const minPriceValue = document.getElementById('min-price-value');
const maxPriceValue = document.getElementById('max-price-value');

// Function to update the displayed min and max price values
function updateSliderTrack() {
    let minValue = parseInt(minPriceSlider.value);
    let maxValue = parseInt(maxPriceSlider.value);

    // Ensure that minValue is always less than maxValue
    if (minValue >= maxValue) {
        minPriceSlider.value = maxValue - 1; // Prevent min slider from crossing max slider
        minValue = maxPriceSlider.value - 1;
    } else if (maxValue <= minValue) {
        maxPriceSlider.value = minValue + 1; // Prevent max slider from crossing min slider
        maxValue = minPriceSlider.value + 1;
    }

    // Update the price labels
    minPriceValue.textContent = `$${minPriceSlider.value}`;
    maxPriceValue.textContent = `$${maxPriceSlider.value}`;
}

// Attach event listeners to sliders
minPriceSlider.addEventListener('input', updateSliderTrack);
maxPriceSlider.addEventListener('input', updateSliderTrack);

// Toggle price dropdown visibility
document.getElementById('price-dropdown-btn').addEventListener('click', function() {
    var dropdown = document.getElementById('price-dropdown');
    dropdown.classList.toggle('hidden');
});

// Apply price filter when the button is clicked
document.getElementById('apply-price-filter').addEventListener('click', function() {
    var minPrice = parseInt(minPriceSlider.value);
    var maxPrice = parseInt(maxPriceSlider.value);
    
    applyPriceFilter(minPrice, maxPrice);
    document.getElementById('price-dropdown').classList.add('hidden');
});

// Apply the price filter logic based on selected min and max price
function applyPriceFilter(minPrice, maxPrice) {
    refreshProducts(minPrice, maxPrice);
    
    const activeFilters = document.getElementById('active-filters');
    const existingPriceFilter = document.getElementById('active-price-filter');
    if (existingPriceFilter) {
        existingPriceFilter.innerText = `Price: $${minPrice} - $${maxPrice} ×`;
    } else {
        const filterTag = document.createElement('div');
        filterTag.id = 'active-price-filter';
        filterTag.className = 'px-4 py-2 bg-gray-200 rounded-full';
        filterTag.innerText = `Price: $${minPrice} - $${maxPrice} ×`;
        activeFilters.appendChild(filterTag);

        // Add click event to remove the price filter
        filterTag.addEventListener('click', function() {
            filterTag.remove();
            refreshProducts();  // Reload all products without filter
        });
    }
}

// Function to fetch and refresh products
async function refreshProducts(minPrice = 50, maxPrice = 500) {
    document.getElementById("product_table").innerHTML = "";

    const products = await getProducts();

    let htmlString = "";

    products.forEach((item) => {
        const price = item.fields.price;
        if (price >= minPrice && price <= maxPrice) {
            htmlString += `
            <div class="relative bg-white shadow-md rounded-lg mb-6 flex flex-col border border-gray-200 p-4">
                <!-- Product Image -->
                <img src="${item.fields.image}" alt="${item.fields.name}" class="w-full h-48 object-cover mb-4">
                
                <!-- Product Details -->
                <div class="flex flex-col justify-between">
                    <h3 class="text-black font-bold text-lg mb-2">${item.fields.name}</h3>
                    <p class="text-gray-500">${item.fields.brand}</p>
                    <p class="text-black font-semibold text-lg">$${item.fields.price}</p>
                </div>
            </div>
            `;
        }
    });

    // Display the products in a grid layout
    document.getElementById("product_table").className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6";
    document.getElementById("product_table").innerHTML = htmlString;
}

// Fetch products as JSON
async function getProducts() {
    return fetch("{% url 'catalog:get_product_json' %}").then((res) => res.json());
}

// Initialize slider track on load
updateSliderTrack();
window.onload = function() {
    refreshProducts();
};
</script>

{% endblock content %}
